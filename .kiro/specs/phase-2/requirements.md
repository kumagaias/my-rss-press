# 要件定義書（Phase 2: 日次新聞機能）

## はじめに

このドキュメントは、MyRSSPressのPhase 2機能に関する要件を定義します。Phase 2では、日次新聞の概念を導入し、ユーザーが毎日新しい新聞を生成・閲覧できるようにします。

## 用語集

- **日次新聞**: 特定の日付に生成された新聞。同じフィード構成で毎日新しい記事を取得
- **新聞シリーズ**: 同じフィード構成で生成された複数の日次新聞のコレクション
- **再生成**: 同じ日付の新聞を最新の記事で作り直す機能
- **言語フィルタ**: 新聞の言語設定に基づいて表示する新聞を絞り込む機能
- **著作権フリー素材**: Unsplash APIなどから取得する無料で使用可能な画像
- **ロケール**: 新聞の言語とタイムゾーンの組み合わせ（`ja`, `en-US`, `en-GB`）
- **発行日**: 新聞が生成された日付。ロケールのタイムゾーンで表示される
- **新聞サマリー**: 新聞全体の内容を3行で要約したテキスト。AIが生成する
- **新聞名検索**: Popular Newspapersセクションで新聞名をキーワードで検索する機能

## 要件

### 要件1: 日次新聞の記事取得期間

**ユーザーストーリー:** ユーザーとして、新聞を生成する際に前日〜当日の記事のみを取得したい。そうすることで、最新のニュースだけを読める。

#### 受入基準

1. 新聞を生成するとき、MyRSSPressシステムは前日0時から当日23時59分59秒までの記事を取得しなければならない
2. 記事を取得するとき、MyRSSPressシステムは記事の公開日（pubDate）が前日0時から当日23時59分59秒の範囲内であることを確認しなければならない
3. 前日〜当日の記事数が最小記事数（3記事）未満のとき、MyRSSPressシステムは過去7日間まで遡って記事を取得しなければならない
4. 過去に遡って記事を取得するとき、MyRSSPressシステムは1日ずつ遡り、最小記事数に達したら停止しなければならない
5. 7日間遡っても最小記事数に達しないとき、MyRSSPressシステムは取得できた記事で新聞を生成しなければならない
6. 記事を取得するとき、MyRSSPressシステムは記事の公開日を基準に新しい順に並べなければならない

### 要件2: 新聞URLへの日付追加

**ユーザーストーリー:** ユーザーとして、新聞のURLに日付が含まれていてほしい。そうすることで、特定の日の新聞を直接URLで指定できる。

#### 受入基準

1. 新聞を生成するとき、MyRSSPressシステムは新聞IDに日付を含めなければならない
2. 新聞IDを生成するとき、MyRSSPressシステムは以下の形式を使用しなければならない：
   - 形式: `{seriesId}_{YYYY-MM-DD}`
   - 例: `abc123_2025-12-08`
3. 新聞のURLを生成するとき、MyRSSPressシステムは以下の形式を使用しなければならない：
   - 形式: `/newspaper?id={seriesId}_{YYYY-MM-DD}`
   - 例: `/newspaper?id=abc123_2025-12-08`
4. URLから新聞を取得するとき、MyRSSPressシステムは新聞IDから日付を抽出しなければならない
5. 日付を抽出するとき、MyRSSPressシステムはYYYY-MM-DD形式の日付文字列を検証しなければならない
6. 無効な日付形式のとき、MyRSSPressシステムはエラーを返さなければならない

### 要件3: 新聞の再生成機能

**ユーザーストーリー:** ユーザーとして、同じ日の新聞を最新の記事で再生成したい。そうすることで、フィードが更新された後に新しい記事を読める。

#### 受入基準

1. 新聞ページを表示するとき、MyRSSPressシステムは「再生成」ボタンを表示しなければならない
2. ユーザーが「再生成」ボタンをクリックしたとき、MyRSSPressシステムは確認ダイアログを表示しなければならない
3. 確認ダイアログを表示するとき、MyRSSPressシステムは「現在の新聞を最新の記事で再生成しますか？」というメッセージを含めなければならない
4. ユーザーが再生成を確認したとき、MyRSSPressシステムは同じフィード構成で新しい記事を取得しなければならない
5. 新しい記事を取得するとき、MyRSSPressシステムは要件1の記事取得期間ルールに従わなければならない
6. 記事を取得した後、MyRSSPressシステムは既存の新聞データを上書きしなければならない
7. 新聞を上書きするとき、MyRSSPressシステムは以下のフィールドを更新しなければならない：
   - articles: 新しい記事リスト
   - updatedAt: 更新日時
8. 新聞を上書きするとき、MyRSSPressシステムは以下のフィールドを保持しなければならない：
   - newspaperId: 新聞ID（日付を含む）
   - name: 新聞名
   - userName: ユーザー名
   - feedUrls: フィードURLリスト
   - createdAt: 作成日時
   - viewCount: 閲覧数
   - isPublic: 公開設定
   - locale: 言語設定
9. 再生成が完了したとき、MyRSSPressシステムはページをリロードして新しい記事を表示しなければならない
10. 再生成中、MyRSSPressシステムはローディングインジケーターを表示しなければならない

### 要件4: 新聞シリーズのデータ構造

**ユーザーストーリー:** 開発者として、同じフィード構成の新聞を日付ごとに管理したい。そうすることで、ユーザーが過去の新聞を閲覧できる。

#### 受入基準

1. 新聞を保存するとき、MyRSSPressシステムは以下のフィールドを含めなければならない：
   - seriesId: シリーズID（UUID）
   - publishDate: 発行日（YYYY-MM-DD形式）
   - newspaperId: 新聞ID（{seriesId}_{publishDate}形式）
2. DynamoDBテーブルを設計するとき、MyRSSPressシステムは以下の構造を使用しなければならない：
   - PK: `SERIES#{seriesId}`
   - SK: `DATE#{publishDate}`
3. GSIを設計するとき、MyRSSPressシステムは以下のインデックスを作成しなければならない：
   - GSI名: `PublicNewspapersByDate`
   - PK: `PUBLIC#{locale}`
   - SK: `DATE#{publishDate}#{seriesId}`
4. 新聞を取得するとき、MyRSSPressシステムは以下のクエリパターンをサポートしなければならない：
   - 特定日の新聞取得: `GetItem(PK=SERIES#{seriesId}, SK=DATE#{publishDate})`
   - シリーズの全新聞取得: `Query(PK=SERIES#{seriesId}, SK begins_with DATE#)`
   - 公開新聞の日付順取得: `Query(GSI=PublicNewspapersByDate, PK=PUBLIC#{locale})`
5. 新聞を保存するとき、MyRSSPressシステムは以下のメタデータを含めなければならない：
   - name: 新聞名
   - userName: ユーザー名
   - feedUrls: フィードURLリスト
   - isPublic: 公開設定
   - locale: 言語設定
6. 新聞シリーズを作成するとき、MyRSSPressシステムは新しいseriesIdを生成しなければならない
7. 同じシリーズの新聞を作成するとき、MyRSSPressシステムは既存のseriesIdを使用しなければならない

### 要件5: 日付ごとの新聞閲覧

**ユーザーストーリー:** ユーザーとして、同じシリーズの過去の新聞を日付ごとに閲覧したい。そうすることで、過去のニュースを振り返れる。

#### 受入基準

1. 新聞ページを表示するとき、MyRSSPressシステムは「前の日」ボタンを表示しなければならない
2. 「前の日」ボタンを表示するとき、MyRSSPressシステムは過去2日分のみ有効にしなければならない
3. ユーザーが「前の日」ボタンをクリックしたとき、MyRSSPressシステムは前日の新聞を取得しなければならない
4. 前日の新聞を取得するとき、MyRSSPressシステムは以下のクエリを実行しなければならない：
   - `GetItem(PK=SERIES#{seriesId}, SK=DATE#{previousDate})`
5. 前日の新聞が存在しないとき、MyRSSPressシステムは「前の日の新聞はありません」というメッセージを表示しなければならない
6. 前日の新聞が存在するとき、MyRSSPressシステムはその新聞のページに遷移しなければならない
7. 現在の日付から2日以上前の新聞のとき、MyRSSPressシステムは「前の日」ボタンを無効化しなければならない
8. 「前の日」ボタンが無効化されているとき、MyRSSPressシステムはツールチップで「過去2日分のみ閲覧可能です」と表示しなければならない
9. 新聞ページを表示するとき、MyRSSPressシステムは現在の日付と最新日付の差を計算しなければならない
10. 日付の差が2日以内のとき、MyRSSPressシステムは「前の日」ボタンを有効にしなければならない
11. 日付の差が2日を超えるとき、MyRSSPressシステムは「前の日」ボタンを無効にしなければならない
12. データベースに保存するとき、MyRSSPressシステムは2日以上前の新聞も保持しなければならない

### 要件6: メインエリアの画像必須化

**ユーザーストーリー:** ユーザーとして、新聞のメインエリアには必ず画像が表示されてほしい。そうすることで、視覚的に魅力的な新聞を楽しめる。

#### 受入基準

1. 新聞のレイアウトを計算するとき、MyRSSPressシステムはメインエリア（lead article）に画像付き記事を優先的に配置しなければならない
2. 画像付き記事が存在するとき、MyRSSPressシステムは最も重要度の高い画像付き記事をメインエリアに配置しなければならない
3. 画像付き記事が存在しないとき、MyRSSPressシステムは著作権フリーの画像を取得しなければならない
4. 著作権フリーの画像を取得するとき、MyRSSPressシステムはUnsplash APIを使用しなければならない
5. Unsplash APIを呼び出すとき、MyRSSPressシステムは記事のタイトルまたはテーマをキーワードとして使用しなければならない
6. Unsplash APIから画像を取得したとき、MyRSSPressシステムは以下の情報を記録しなければならない：
   - imageUrl: 画像URL
   - imageAttribution: 写真家の名前とUnsplashへのリンク
7. 著作権フリーの画像を表示するとき、MyRSSPressシステムは画像の下に帰属表示を含めなければならない
8. 帰属表示を表示するとき、MyRSSPressシステムは以下の形式を使用しなければならない：
   - 形式: "Photo by {photographer} on Unsplash"
   - リンク: Unsplashの写真ページへのリンク
9. Unsplash APIが利用できないとき、MyRSSPressシステムはデフォルトのプレースホルダー画像を使用しなければならない
10. プレースホルダー画像を使用するとき、MyRSSPressシステムは新聞のテーマに合った汎用的な画像を選択しなければならない

### 要件7: Popular Newspapersの表示順序

**ユーザーストーリー:** ユーザーとして、Popular Newspapersセクションで最新の新聞を優先的に見たい。そうすることで、新しいコンテンツを発見しやすくなる。

#### 受入基準

1. Popular Newspapersセクションを表示するとき、MyRSSPressシステムはソート選択UIを表示しなければならない
2. ソート選択UIを表示するとき、MyRSSPressシステムは以下のオプションを提供しなければならない：
   - Recent（最新順）
   - Popular（人気順）
3. ソート選択UIを表示するとき、MyRSSPressシステムは「Recent」をデフォルトで選択しなければならない
4. ソート選択UIを配置するとき、MyRSSPressシステムは「Recent」を左側、「Popular」を右側に配置しなければならない
5. ユーザーが「Recent」を選択したとき、MyRSSPressシステムは新聞を発行日の降順に並べなければならない
6. ユーザーが「Popular」を選択したとき、MyRSSPressシステムは新聞を閲覧数の降順に並べなければならない
7. ソート順を変更したとき、MyRSSPressシステムは即座に新聞リストを更新しなければならない
8. ページをリロードしたとき、MyRSSPressシステムはデフォルトの「Recent」ソートを適用しなければならない

### 要件8: 言語フィルタ機能

**ユーザーストーリー:** ユーザーとして、Popular Newspapersセクションで特定の言語の新聞のみを表示したい。そうすることで、読める言語の新聞だけを効率的に探せる。

#### 受入基準

1. Popular Newspapersセクションを表示するとき、MyRSSPressシステムは言語フィルタUIを表示しなければならない
2. 言語フィルタUIを表示するとき、MyRSSPressシステムは以下のオプションを提供しなければならない：
   - All（すべて）
   - 日本語のみ
   - English (US) only
   - English (UK) only
3. 言語フィルタUIを表示するとき、MyRSSPressシステムは「All」をデフォルトで選択しなければならない
4. ユーザーが「All」を選択したとき、MyRSSPressシステムはすべての言語の新聞を表示しなければならない
5. ユーザーが「日本語のみ」を選択したとき、MyRSSPressシステムは`locale`が`ja`の新聞のみを表示しなければならない
6. ユーザーが「English (US) only」を選択したとき、MyRSSPressシステムは`locale`が`en-US`の新聞のみを表示しなければならない
7. ユーザーが「English (UK) only」を選択したとき、MyRSSPressシステムは`locale`が`en-GB`の新聞のみを表示しなければならない
8. 言語フィルタを変更したとき、MyRSSPressシステムは即座に新聞リストを更新しなければならない
9. 言語フィルタとソート順を組み合わせるとき、MyRSSPressシステムは両方の条件を適用しなければならない
10. 新聞を取得するとき、MyRSSPressシステムは以下のクエリパターンを使用しなければならない：
   - All: `Query(GSI=PublicNewspapersByDate, PK=PUBLIC)`
   - 日本語のみ: `Query(GSI=PublicNewspapersByDate, PK=PUBLIC#ja)`
   - English (US) only: `Query(GSI=PublicNewspapersByDate, PK=PUBLIC#en-US)`
   - English (UK) only: `Query(GSI=PublicNewspapersByDate, PK=PUBLIC#en-GB)`
11. 言語フィルタUIを配置するとき、MyRSSPressシステムはソート選択UIの上または横に配置しなければならない
12. ページをリロードしたとき、MyRSSPressシステムはデフォルトの「All」フィルタを適用しなければならない
13. 新聞カードを表示するとき、MyRSSPressシステムは新聞の言語を示すバッジを表示しなければならない
14. 言語バッジを表示するとき、MyRSSPressシステムは以下の形式を使用しなければならない：
   - 日本語: 「🇯🇵 日本語」
   - English (US): 「🇺🇸 English (US)」
   - English (UK): 「🇬🇧 English (UK)」

### 要件9: 新聞サマリーの自動生成

**ユーザーストーリー:** ユーザーとして、新聞の上部に全体の要約を見たい。そうすることで、記事を読む前に新聞の内容を素早く把握できる。

#### 受入基準

1. 新聞を生成するとき、MyRSSPressシステムは記事リストからサマリーを生成しなければならない
2. サマリーを生成するとき、MyRSSPressシステムはAWS Bedrock Runtime APIを使用しなければならない
3. Bedrock Runtime APIを呼び出すとき、MyRSSPressシステムは以下のモデルを使用しなければならない：
   - モデルID: `anthropic.claude-3-5-haiku-20241022-v1:0`
4. Bedrock Runtime APIを呼び出すとき、MyRSSPressシステムは以下のプロンプトを使用しなければならない：
   ```
   以下の記事タイトルから、この新聞全体の内容を3行で要約してください。
   各行は簡潔に、重要なトピックを含めてください。
   
   記事タイトル：
   - {article1.title}
   - {article2.title}
   - ...
   
   要約（3行）：
   ```
5. サマリーを生成するとき、MyRSSPressシステムは正確に3行のテキストを生成しなければならない
6. サマリーを生成するとき、MyRSSPressシステムは新聞の`locale`に応じた言語で生成しなければならない：
   - `ja`: 日本語
   - `en-US`: 英語
   - `en-GB`: 英語
7. 新聞を保存するとき、MyRSSPressシステムは`summary`フィールドにサマリーテキストを保存しなければならない
8. 新聞ページを表示するとき、MyRSSPressシステムは新聞タイトルと記事リストの間にサマリーを表示しなければならない
9. サマリーを表示するとき、MyRSSPressシステムは以下のスタイルを適用しなければならない：
   - フォントサイズ: 中サイズ（記事タイトルより小さく、本文より大きい）
   - 行間: 適度な余白
   - 配置: 左寄せまたは中央寄せ
   - 背景: 薄いグレーまたは枠線で区別
10. Bedrock APIが失敗したとき、MyRSSPressシステムはデフォルトのサマリーを使用しなければならない：
    - 形式: "This newspaper contains {記事数} articles about {主要トピック}."
11. サマリー生成中、MyRSSPressシステムはローディングインジケーターを表示しなければならない
12. サマリー生成のタイムアウトを設定するとき、MyRSSPressシステムは10秒を上限としなければならない
13. タイムアウトが発生したとき、MyRSSPressシステムはデフォルトのサマリーを使用しなければならない
14. 新聞を再生成するとき、MyRSSPressシステムは新しい記事リストから新しいサマリーを生成しなければならない

### 要件10: 新聞名検索機能

**ユーザーストーリー:** ユーザーとして、Popular Newspapersセクションで新聞名を検索したい。そうすることで、興味のある新聞を素早く見つけられる。

#### 受入基準

1. Popular Newspapersセクションを表示するとき、MyRSSPressシステムは検索フィールドを表示しなければならない
2. 検索フィールドを配置するとき、MyRSSPressシステムはセクションタイトルの下、言語フィルタとソート選択UIの上に配置しなければならない
3. 検索フィールドを表示するとき、MyRSSPressシステムは以下のプレースホルダーテキストを表示しなければならない：
   - `ja`: 「新聞名で検索...」
   - `en-US`, `en-GB`: 「Search by newspaper name...」
4. ユーザーが検索フィールドに入力したとき、MyRSSPressシステムはリアルタイムで新聞リストをフィルタリングしなければならない
5. 新聞をフィルタリングするとき、MyRSSPressシステムは新聞名（`name`フィールド）に検索キーワードが含まれる新聞のみを表示しなければならない
6. 検索を実行するとき、MyRSSPressシステムは大文字小文字を区別しない検索を行わなければならない
7. 検索を実行するとき、MyRSSPressシステムは部分一致検索を行わなければならない
8. 検索キーワードが空のとき、MyRSSPressシステムはすべての新聞を表示しなければならない
9. 検索結果が0件のとき、MyRSSPressシステムは「検索結果が見つかりませんでした」というメッセージを表示しなければならない
10. 検索フィルタを適用するとき、MyRSSPressシステムは言語フィルタとソート順も同時に適用しなければならない
11. 検索フィールドをクリアするとき、MyRSSPressシステムは「×」ボタンを表示しなければならない
12. ユーザーが「×」ボタンをクリックしたとき、MyRSSPressシステムは検索フィールドをクリアしてすべての新聞を表示しなければならない
13. 検索フィールドのスタイルを設定するとき、MyRSSPressシステムは以下を適用しなければならない：
    - 幅: 100%（モバイル）、50%（デスクトップ）
    - 高さ: 44px以上（タッチフレンドリー）
    - アイコン: 検索アイコン（🔍）を左側に表示
14. ページをリロードしたとき、MyRSSPressシステムは検索フィールドを空にしなければならない

### 要件11: ロケール対応の発行日表示

**ユーザーストーリー:** ユーザーとして、新聞の発行日を自分の地域のタイムゾーンで見たい。そうすることで、いつ発行された新聞かを正確に理解できる。

#### 受入基準

1. 新聞を保存するとき、MyRSSPressシステムは`createdAt`をUTC（ISO 8601形式）で保存しなければならない
2. 新聞を表示するとき、MyRSSPressシステムは`locale`に基づいて適切なタイムゾーンで日付を表示しなければならない
3. ロケールとタイムゾーンの対応は以下でなければならない：
   - `ja`: Asia/Tokyo (UTC+9)
   - `en-US`: America/New_York (UTC-5/-4)
   - `en-GB`: Europe/London (UTC+0/+1)
4. 日付を表示するとき、MyRSSPressシステムは以下の形式を使用しなければならない：
   - `ja`: 「2025年12月8日 月曜日」
   - `en-US`: 「Monday, December 8, 2025」
   - `en-GB`: 「Monday, 8 December 2025」
5. 日付をフォーマットするとき、MyRSSPressシステムは`toLocaleDateString()`メソッドを使用しなければならない
6. `toLocaleDateString()`を呼び出すとき、MyRSSPressシステムは以下のオプションを指定しなければならない：
   - `timeZone`: ロケールに対応するタイムゾーン
   - `weekday`: 'long'
   - `year`: 'numeric'
   - `month`: 'long'
   - `day`: 'numeric'
7. 新聞カードを表示するとき、MyRSSPressシステムは発行日をロケールに応じた形式で表示しなければならない
8. 新聞ページのヘッダーを表示するとき、MyRSSPressシステムは発行日をロケールに応じた形式で表示しなければならない
9. Popular Newspapersセクションを表示するとき、MyRSSPressシステムは各新聞の発行日をそれぞれのロケールで表示しなければならない
10. 日付フォーマット関数を実装するとき、MyRSSPressシステムは`lib/i18n.ts`に`formatNewspaperDate()`関数を追加しなければならない
11. `formatNewspaperDate()`関数を実装するとき、MyRSSPressシステムは以下のシグネチャを使用しなければならない：
    ```typescript
    function formatNewspaperDate(isoDate: string, locale: Locale): string
    ```
12. タイムゾーン情報を管理するとき、MyRSSPressシステムは`lib/i18n.ts`に`timezones`オブジェクトを定義しなければならない：
    ```typescript
    const timezones: Record<Locale, string> = {
      'ja': 'Asia/Tokyo',
      'en-US': 'America/New_York',
      'en-GB': 'Europe/London',
    }
    ```

## 設計上の考慮事項

Phase 2の実装では、以下の点を考慮する必要があります：

1. **データモデルの拡張**:
   - 既存の`NewspaperData`インターフェースに`seriesId`と`publishDate`を追加
   - `newspaperId`の形式を`{seriesId}_{publishDate}`に変更
   - `locale`の型を`'ja' | 'en-US' | 'en-GB'`に拡張
   - `summary`フィールドを追加（string型、3行のテキスト）

2. **DynamoDBテーブル設計**:
   - 既存のテーブル構造を維持しつつ、新しいGSIを追加
   - `PublicNewspapersByDate`インデックスで言語別・日付別の取得を効率化
   - `createdAt`は引き続きUTC（ISO 8601）で保存

3. **Unsplash API統合**:
   - Unsplash APIキーの環境変数管理
   - レート制限の考慮（1時間あたり50リクエスト）
   - 画像キャッシュの検討

4. **パフォーマンス最適化**:
   - 過去の新聞データのキャッシュ
   - 画像の遅延読み込み
   - ページネーションの実装

5. **エラーハンドリング**:
   - Unsplash API障害時のフォールバック
   - 無効な日付形式のエラーメッセージ
   - 新聞が存在しない場合の適切な表示

6. **UI/UX**:
   - 日付ナビゲーションの直感的な配置
   - 言語フィルタとソート選択の使いやすい配置
   - 検索フィールドの目立つ配置（セクションタイトル直下）
   - ローディング状態の適切な表示
   - 再生成確認ダイアログの明確なメッセージ
   - ロケールに応じた日付表示の一貫性
   - リアルタイム検索のスムーズな動作

7. **環境変数**:
   - `UNSPLASH_ACCESS_KEY`: Unsplash APIアクセスキー
   - `UNSPLASH_API_URL`: Unsplash APIエンドポイント（デフォルト: https://api.unsplash.com）
   - `BEDROCK_REGION`: Bedrock APIのリージョン（デフォルト: ap-northeast-1）

8. **テスト戦略**:
   - 日付計算ロジックのユニットテスト
   - タイムゾーン変換のユニットテスト
   - Unsplash API統合のモックテスト
   - Bedrock Runtime API統合のモックテスト
   - サマリー生成ロジックのユニットテスト
   - 検索フィルタリングロジックのユニットテスト
   - 言語フィルタのE2Eテスト
   - 新聞名検索のE2Eテスト
   - 新聞再生成のE2Eテスト
   - ロケール別日付表示のE2Eテスト
   - サマリー表示のE2Eテスト

9. **国際化（i18n）**:
   - `lib/i18n.ts`に`formatNewspaperDate()`関数を追加
   - タイムゾーン情報を`timezones`オブジェクトで管理
   - フロントエンドでタイムゾーン変換を実施（DBはUTCのまま）
   - 各ロケールの日付フォーマット規則に準拠
   - サマリー生成時にロケールに応じた言語を使用

10. **Bedrock Runtime API統合**:
   - AWS SDK v3の`@aws-sdk/client-bedrock-runtime`を使用
   - `InvokeModelCommand`でClaude 3 Haikuを呼び出し
   - プロンプトは記事タイトルのリストから3行サマリーを生成
   - タイムアウト: 10秒
   - エラー時のフォールバック: デフォルトサマリー
   - レスポンスのパース: JSON形式で3行のテキストを抽出
